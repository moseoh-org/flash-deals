# 핫딜 주문 시 서버 과부하

## 상황

핫딜 오픈 시 순간적으로 대량의 주문 요청이 몰려 서버가 처리할 수 있는 한계를 초과한다.
동시 요청이 처리 능력을 넘어서면 응답 지연이 발생하고, 타임아웃으로 주문 실패가 발생한다.

## 테스트 환경

- 부하 테스트: `make load-order-overload`
- 테스트 대상: `POST /orders` (핫딜 주문)
- Product Service: 2 레플리카, Go Channel 버퍼 10,000

---

## 기존 시스템 (동기 처리)

### 부하 테스트 결과

| VU | 처리량 | p95 응답시간 | 에러율 |
|----|--------|-------------|--------|
| 500 | 764 req/s | 399ms | 0% |
| 1000 | 597 req/s | 1148ms | 0% |
| 2000 | ~400 req/s | 2000ms+ | 대량 타임아웃 |

### 분석

- **500 VU**: 서버가 여유있게 처리
- **1000 VU**: 처리량 감소, 응답시간 3배 증가 (포화 상태 진입)
- **2000 VU**: 타임아웃 에러 대량 발생 (처리 한계 초과)

### 문제점

- 동시 요청이 처리 능력을 초과하면 타임아웃 발생
- 사용자에게 "주문 실패" 에러 표시
- 재시도 → 추가 부하 → 악순환

---

## 개선: 메시지 큐 (Redis Streams)

### 변경 내용

- 주문 요청을 즉시 Redis Streams에 적재
- 클라이언트에게 "주문 접수" 즉시 응답 (202 Accepted)
- Consumer가 비동기로 주문 처리
- 처리량 초과해도 에러 없이 대기열에서 순차 처리

### 동작 방식

```
요청 1~N ──→ Redis Streams에 즉시 적재 (XADD)
          ←─ "주문 접수됨" 즉시 응답 (202 Accepted)
               ↓
        Consumer Group이 순차적으로 처리
               ↓
        주문 완료 시 알림 (웹소켓/폴링)
```

### 기대 효과

| 항목 | Before (동기) | After (Redis Streams) |
|------|--------------|----------------------|
| 응답 | 처리 완료까지 대기 | 즉시 접수 응답 |
| 에러 | 타임아웃 시 실패 | 에러 없음 (대기열 적재) |
| 확장성 | 처리 능력 한계 | 무제한 큐 |
| 상태 확인 | 불가 | 대기열 순번 조회 가능 |

---

## 비교 요약

| 항목 | 동기 처리 | Redis Streams |
|------|----------|---------------|
| 응답 방식 | 처리 완료 후 응답 | 즉시 접수 응답 |
| 과부하 시 | 타임아웃 에러 | 대기열 증가 |
| 서버 재시작 | - | 데이터 유지 |
| 구현 복잡도 | 낮음 | 높음 |
