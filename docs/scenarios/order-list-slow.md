# 주문 목록 조회가 느림

## 상황

주문이 많은 VIP 고객이 주문 내역 페이지를 열 때 로딩이 매우 느리다.
주문이 적은 일반 사용자는 정상인데, 주문이 많을수록 느려지는 패턴이 발견되었다.

## 테스트 환경

- 부하 테스트: `make load-order-list`
- 최대 VU: 20
- 테스트 대상: `GET /orders` (주문 목록 조회)
- 사용자당 주문: 100건

---

## 기존 시스템

### 성능

| 지표          | 값       |
| ------------- | -------- |
| p95 응답시간  | 410ms    |
| 평균 응답시간 | 285ms    |
| 처리량        | 48req/s  |
| 에러율        | 0%       |

### 리소스 사용량

| 컨테이너 | CPU |
| -------- | --- |
| postgres | 27% |
| order    | 57% |
| gateway  | 57% |

### 문제점

- N+1 쿼리 발생: 주문 20건 조회 시 21번 쿼리 실행
- 주문 수에 비례하여 응답 시간 증가

---

## 개선 1: JOIN 쿼리로 N+1 해결

### 변경 내용

- 주문 + 아이템을 LEFT JOIN으로 한 번에 조회
- Python에서 결과를 주문별로 그룹핑
- 21번 쿼리 → 1번 쿼리

### 성능

| 지표          | Before  | After   | 개선  |
| ------------- | ------- | ------- | ----- |
| p95 응답시간  | 410ms   | 361ms   | 12% ↓ |
| 평균 응답시간 | 285ms   | 252ms   | 12% ↓ |
| 처리량        | 48req/s | 52req/s | 9% ↑  |
| 에러율        | 0%      | 0%      | -     |

### 리소스 사용량 비교

| 컨테이너 | Before | After |
| -------- | ------ | ----- |
| postgres | 27%    | 32%   |
| order    | 57%    | 49%   |
| gateway  | 57%    | 47%   |

### 분석

- 쿼리 횟수 21번 → 1번으로 감소
- 개선폭이 12%로 제한적인 이유:
  - 인덱스(`idx_order_items_order_id`)가 있어서 개별 쿼리도 빠름 (0.4ms)
  - 실제 병목은 Gateway 경유, JWT 검증, Python 처리 오버헤드
