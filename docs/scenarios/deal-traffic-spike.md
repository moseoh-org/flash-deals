# 핫딜 트래픽 급증

## 상황

핫딜 오픈 시간에 맞춰 순간적으로 트래픽이 폭주한다.
평소 100 TPS에서 핫딜 오픈 시 10,000 TPS 이상으로 급증하며, 서버가 과부하로 다운되는 상황이 발생한다.

## 테스트 환경

- 부하 테스트: `make load-deal-spike`
- 최대 VU: 100
- 테스트 대상: `GET /products/deals` (핫딜 목록 조회)

---

## 기존 시스템

### 성능

| 지표          | 값        |
| ------------- | --------- |
| p95 응답시간  | 1089ms    |
| 평균 응답시간 | 486ms     |
| 처리량        | 133req/s  |
| 에러율        | 0%        |

### 리소스 사용량

| 컨테이너 | CPU  |
| -------- | ---- |
| gateway  | 101% |
| auth     | 20%  |
| product  | 7%   |
| postgres | 4%   |

### 문제점

- Gateway CPU 101%로 병목 발생
- p95 1089ms로 목표치(1000ms) 초과
- httpx 클라이언트를 매 요청마다 생성/해제

---

## 개선 1: httpx 커넥션 풀 재사용

### 변경 내용

- 전역 `httpx.AsyncClient` 생성하여 커넥션 풀 재사용
- `max_connections=100`, `max_keepalive_connections=20` 설정
- FastAPI lifespan으로 종료 시 클라이언트 정리

### 성능

| 지표          | Before   | After    | 개선    |
| ------------- | -------- | -------- | ------- |
| p95 응답시간  | 1089ms   | 295ms    | 3.7배 ↓ |
| 평균 응답시간 | 486ms    | 95ms     | 5.1배 ↓ |
| 처리량        | 133req/s | 498req/s | 3.7배 ↑ |
| 에러율        | 0%       | 0%       | -       |

### 리소스 사용량 비교

| 컨테이너 | Before | After |
| -------- | ------ | ----- |
| gateway  | 101%   | 101%  |
| auth     | 20%    | 92%   |
| product  | 7%     | 30%   |
| postgres | 4%     | 17%   |

### 분석

- 동일한 Gateway CPU 100%에서 처리량 3.7배 증가
- 커넥션 재사용으로 TCP 핸드셰이크 오버헤드 제거
- 병목이 Gateway → Auth 서비스(92%)로 이동

---

## 개선 2: Kong Gateway 도입

### 변경 내용

- Python FastAPI Gateway를 Kong Gateway로 교체
- DB-less 모드 (선언적 YAML 설정)
- OpenTelemetry 플러그인으로 트레이싱 유지

### 성능

| 지표          | Before   | After    | 개선    |
| ------------- | -------- | -------- | ------- |
| p95 응답시간  | 295ms    | 129ms    | 2.3배 ↓ |
| 평균 응답시간 | 95ms     | 23ms     | 4.1배 ↓ |
| 처리량        | 498req/s | 982req/s | 2.0배 ↑ |
| 에러율        | 0%       | 0%       | -       |

### 리소스 사용량 비교

| 컨테이너 | Before | After |
| -------- | ------ | ----- |
| gateway  | 101%   | 33%   |
| auth     | 92%    | 80%   |
| product  | 30%    | 66%   |
| postgres | 17%    | 14%   |

### 분석

- Gateway CPU 101% → 33% (3배 여유)
- 처리량 2배 증가에도 CPU 사용률 1/3로 감소
- 병목이 Auth(80%), Product(66%)로 이동

---

## 전체 개선 요약

| 단계              | 처리량   | p95 응답 | Gateway CPU |
| ----------------- | -------- | -------- | ----------- |
| 기존 (Python)     | 133req/s | 1089ms   | 101%        |
| 개선 1 (httpx 풀) | 498req/s | 295ms    | 101%        |
| 개선 2 (Kong)     | 982req/s | 129ms    | 33%         |

### 최종 결과: 기존 대비

- 처리량: 133req/s → 982req/s (**7.4배 증가**)
- 응답시간: p95 1089ms → 129ms (**8.4배 감소**)
- Gateway CPU: 101% → 33% (**3배 여유**)
