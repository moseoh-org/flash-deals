# 핫딜 트래픽 급증

## 상황

핫딜 오픈 시간에 맞춰 순간적으로 트래픽이 폭주한다.
평소 100 TPS에서 핫딜 오픈 시 10,000 TPS 이상으로 급증하며, 서버가 과부하로 다운되는 상황이 발생한다.

## 테스트 환경

- k6 부하 테스트: `make load-deal-spike`
- 최대 VU: 100
- Ramp-up: 30초, Hold: 30초

---

## 기존 시스템

### 성능

| 지표          | 값        |
| ------------- | --------- |
| p95 응답시간  | 1089.85ms |
| 평균 응답시간 | 485.52ms  |
| 에러율        | 0.00%     |
| 총 요청 수    | 9,368     |

### 리소스 사용량

| 컨테이너 | CPU     | RAM   |
| -------- | ------- | ----- |
| gateway  | 101.04% | 243MB |
| auth     | 19.59%  | 140MB |
| product  | 7.32%   | 92MB  |
| postgres | 3.78%   | 173MB |

### 트레이스 분석 (Grafana Tempo)

| 구간                         | 소요 시간      |
| ---------------------------- | -------------- |
| Gateway 전체                 | 518.44ms       |
| Auth 서비스 (`/auth/verify`) | 6.07ms         |
| Gateway 자체 오버헤드        | ~512ms (98.8%) |

### 문제점

- Gateway CPU 101%로 병목 발생
- p95 1089ms로 목표치(1000ms) 초과
- Auth 서비스는 6ms인데 Gateway에서 512ms 소요
- 원인: httpx 클라이언트를 매 요청마다 생성/해제

---

## 개선 1: httpx 커넥션 풀 재사용

### 변경 내용

- 전역 `httpx.AsyncClient` 생성하여 커넥션 풀 재사용
- `max_connections=100`, `max_keepalive_connections=20` 설정
- FastAPI lifespan으로 종료 시 클라이언트 정리

### 성능

| 지표          | Before | After  | 개선    |
| ------------- | ------ | ------ | ------- |
| p95 응답시간  | 1089ms | 295ms  | 3.7배 ↓ |
| 평균 응답시간 | 485ms  | 95ms   | 5.1배 ↓ |
| 총 요청 수    | 9,368  | 35,111 | 3.7배 ↑ |
| 에러율        | 0%     | 0%     | -       |

### 리소스 사용량 비교

| 컨테이너 | Before (CPU) | After (CPU) |
| -------- | ------------ | ----------- |
| gateway  | 101%         | 101%        |
| auth     | 19.59%       | 91.60%      |
| product  | 7.32%        | 29.77%      |
| postgres | 3.78%        | 17.43%      |

### 분석

- 동일한 Gateway CPU 100%에서 처리량 3.7배 증가
- 커넥션 재사용으로 TCP 핸드셰이크 오버헤드 제거
- 병목이 Gateway → Auth 서비스(91.6%)로 이동
- Gateway 자체가 여전히 병목 (Python 단일 워커 한계)

---

## 개선 2: Kong Gateway 도입

### 변경 내용

- Python FastAPI Gateway를 Kong Gateway로 교체
- DB-less 모드 (선언적 YAML 설정)
- OpenTelemetry 플러그인으로 트레이싱 유지

### 성능

| 지표          | Before (Python) | After (Kong) | 개선    |
| ------------- | --------------- | ------------ | ------- |
| p95 응답시간  | 295ms           | 129ms        | 2.3배 ↓ |
| 평균 응답시간 | 95ms            | 23ms         | 4.1배 ↓ |
| 총 요청 수    | 35,111          | 69,331       | 2.0배 ↑ |
| 에러율        | 0%              | 0%           | -       |

### 리소스 사용량 비교

| 컨테이너 | Before (CPU) | After (CPU) |
| -------- | ------------ | ----------- |
| gateway  | 101%         | 32.55%      |
| auth     | 91.60%       | 79.74%      |
| product  | 29.77%       | 65.99%      |
| postgres | 17.43%       | 14.00%      |

### 분석

- Gateway CPU 101% → 32.55% (3배 여유)
- 처리량 2배 증가에도 CPU 사용률 1/3로 감소
- 병목이 Auth(79%), Product(65%)로 이동
- Gateway 메모리 증가 (105MB → 572MB) - Kong 특성

---

## 전체 개선 효과

| 지표          | 최초   | httpx 풀 | Kong   | 총 개선      |
| ------------- | ------ | -------- | ------ | ------------ |
| p95 응답시간  | 1089ms | 295ms    | 129ms  | **8.4배 ↓**  |
| 평균 응답시간 | 485ms  | 95ms     | 23ms   | **21배 ↓**   |
| 총 요청 수    | 9,368  | 35,111   | 69,331 | **7.4배 ↑**  |
| Gateway CPU   | 101%   | 101%     | 32.55% | **3배 여유** |
