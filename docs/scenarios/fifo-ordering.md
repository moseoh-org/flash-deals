# 선착순 주문 순서 미보장

## 상황

핫딜 상품 구매 시 먼저 요청한 사용자가 구매에 실패하는 현상이 발생한다.
재고 10개인 상품에 User 1~20이 순서대로 요청했으나, 구매 성공자가 1~10이 아닌 랜덤한 10명이다.

## 테스트 환경

- 부하 테스트: `make load-fifo-test`
- 최대 VU: 20 (FIFO), 50 (성능)
- 테스트 대상: `POST /orders` (핫딜 주문)

---

## 기존 시스템

### 성능

| 지표          | 값       |
| ------------- | -------- |
| p95 응답시간  | 19ms     |
| 평균 응답시간 | 9ms      |
| 처리량        | 160req/s |
| 에러율        | 0%       |

### 순서 보장 테스트

| 항목       | 기대값               | 실제값                           |
| ---------- | -------------------- | -------------------------------- |
| 성공 유저  | 1,2,3,4,5,6,7,8,9,10 | 3,6,8,9,14,15,16,17,18,20 (랜덤) |
| 총 성공 수 | 10명                 | 10명                             |
| 순서 보장  | O                    | **X**                            |

### 문제점

- TCP 요청 순서 ≠ 처리 완료 순서
- 멀티스레드 환경에서 동시 처리로 인해 순서 역전 발생
- DB Lock 대기 중에도 연결+트랜잭션 점유 → 커넥션 풀 효율 저하

---

## 개선 1: Go Channel (인메모리 큐)

### 변경 내용

- Go Channel을 FIFO 큐로 활용 (버퍼: 10,000)
- 단일 Worker가 순차적으로 재고 업데이트 처리
- 구현: `services/product/go/internal/queue/stock_queue.go`

### 성능

| 지표          | Before   | After    | 개선    |
| ------------- | -------- | -------- | ------- |
| p95 응답시간  | 19ms     | 14ms     | 26% ↓   |
| 평균 응답시간 | 9ms      | 6ms      | 33% ↓   |
| 처리량        | 160req/s | 303req/s | 1.9배 ↑ |
| 에러율        | 0%       | 0%       | -       |

### 순서 보장 테스트

| 항목      | Before    | After             |
| --------- | --------- | ----------------- |
| 성공 유저 | 랜덤 10명 | 서버 도착 순 10명 |
| 순서 보장 | X         | **O (서버측)**    |

### 분석

- **락 경합 제거**: 순차 처리로 DB Lock 대기 시간 0
- **연결 회전율 상승**: 트랜잭션 즉시 완료 → 커넥션 풀 효율 증가
- **서버 측 FIFO 보장**: Product Service 도착 순서대로 처리

---

## 비교 요약

| 항목      | 기존 (동시) | Go Channel |
| --------- | ----------- | ---------- |
| 처리량    | 160req/s    | 303req/s   |
| 순서 보장 | X           | O (서버측) |
| 적합 환경 | 순서 무관   | 단일 서버  |

> 다중 서버 환경에서의 순서 보장은 [다중 서버 순서 미보장](./multi-server-fifo.md) 참고
