services:
  # ===================
  # Infrastructure
  # ===================
  postgres:
    image: postgres:16-alpine
    container_name: flash-deals-postgres
    environment:
      POSTGRES_USER: flash
      POSTGRES_PASSWORD: flash1234
      POSTGRES_DB: flash_deals
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/app/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U flash -d flash_deals"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flash-network

  redis:
    image: redis:7-alpine
    container_name: flash-deals-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - flash-network

  # ===================
  # Database Migration
  # ===================
  migrate:
    image: migrate/migrate:v4.17.0
    container_name: flash-deals-migrate
    profiles:
      - migration
    volumes:
      - ./services/auth/db/migrations:/migrations/auth:ro
      - ./services/product/db/migrations:/migrations/product:ro
      - ./services/order/db/migrations:/migrations/order:ro
    networks:
      - flash-network
    depends_on:
      postgres:
        condition: service_healthy

  # ===================
  # Services
  # ===================
  gateway:
    image: kong:3.9
    container_name: flash-deals-gateway
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /etc/kong/kong.yml
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
      KONG_PLUGINS: bundled,opentelemetry
      KONG_OPENTELEMETRY_TRACING: all
      KONG_TRACING_INSTRUMENTATIONS: all
      KONG_TRACING_SAMPLING_RATE: "1.0"
    volumes:
      - ./infra/app/gateway/kong.yml:/etc/kong/kong.yml:ro
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      auth:
        condition: service_healthy
      product:
        condition: service_healthy
      order:
        condition: service_healthy
    networks:
      - flash-network
      - monitoring-network

  # Python Gateway (비활성화 - Kong으로 대체)
  # gateway-python:
  #   build:
  #     context: ./services/gateway/python
  #   container_name: flash-deals-gateway-python
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     APP_PORT: 8000
  #     AUTH_SERVICE_URL: http://auth:8001
  #     PRODUCT_SERVICE_URL: http://product:8002
  #     ORDER_SERVICE_URL: http://order:8003
  #     OTEL_ENABLED: true
  #     OTEL_SERVICE_NAME: gateway
  #     OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
  #     OTEL_SEMCONV_STABILITY_OPT_IN: http
  #   healthcheck:
  #     test:
  #       [
  #         "CMD",
  #         "python",
  #         "-c",
  #         "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
  #       ]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5
  #   depends_on:
  #     auth:
  #       condition: service_healthy
  #     product:
  #       condition: service_healthy
  #     order:
  #       condition: service_healthy
  #   networks:
  #     - flash-network
  #     - monitoring-network

  auth:
    build:
      context: ./services/auth/python
    container_name: flash-deals-auth
    environment:
      APP_PORT: 8001
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: flash_deals
      DB_USER: flash
      DB_PASSWORD: flash1234
      JWT_SECRET_KEY: your-secret-key-change-in-production
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 60
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: 7
      JWT_SKIP_VERIFICATION: true  # Kong JWT 플러그인이 검증하므로 스킵
      OTEL_ENABLED: true
      OTEL_SERVICE_NAME: auth-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SEMCONV_STABILITY_OPT_IN: http
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')",
        ]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - flash-network
      - monitoring-network

  # Python Product Service (비활성화 - Go로 대체)
  # product-python:
  #   build:
  #     context: .
  #     dockerfile: services/product/python/Dockerfile
  #   container_name: flash-deals-product
  #   environment:
  #     APP_PORT: 8002
  #     DB_HOST: postgres
  #     DB_PORT: 5432
  #     DB_NAME: flash_deals
  #     DB_USER: flash
  #     DB_PASSWORD: flash1234
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     ENABLE_CACHE: ${ENABLE_CACHE:-true}
  #     CACHE_TTL: 60
  #     GRPC_ENABLED: ${GRPC_ENABLED:-false}
  #     GRPC_PORT: 50051
  #     OTEL_ENABLED: true
  #     OTEL_SERVICE_NAME: product-service
  #     OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
  #     OTEL_SEMCONV_STABILITY_OPT_IN: http
  #     UVICORN_WORKERS: ${UVICORN_WORKERS:-1}
  #   command: >
  #     sh -c "uvicorn src.main:app --host 0.0.0.0 --port 8002 --workers $${UVICORN_WORKERS:-1}"
  #   healthcheck:
  #     test:
  #       [
  #         "CMD",
  #         "python",
  #         "-c",
  #         "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')",
  #       ]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - flash-network
  #     - monitoring-network

  # Go Product Service
  product:
    build:
      context: .
      dockerfile: services/product/go/Dockerfile
    container_name: flash-deals-product
    ports:
      - "8002:8002"
      - "50051:50051"
    environment:
      APP_PORT: 8002
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: flash_deals
      DB_USER: flash
      DB_PASSWORD: flash1234
      # Cache
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ENABLE_CACHE: ${ENABLE_CACHE:-true}
      CACHE_TTL: 60
      # Hotdeal
      HOTDEAL_STOCK_REDIS: ${HOTDEAL_STOCK_REDIS:-false}
      # gRPC
      GRPC_ENABLED: ${GRPC_ENABLED:-true}
      GRPC_PORT: 50051
      # OpenTelemetry
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_SERVICE_NAME: product-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8002/health"]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - flash-network
      - monitoring-network

  # Python Order Service (비활성화 - Go로 대체)
  # order-python:
  #   build:
  #     context: .
  #     dockerfile: services/order/python/Dockerfile
  #   container_name: flash-deals-order
  #   environment:
  #     APP_PORT: 8003
  #     DB_HOST: postgres
  #     DB_PORT: 5432
  #     DB_NAME: flash_deals
  #     DB_USER: flash
  #     DB_PASSWORD: flash1234
  #     PRODUCT_SERVICE_URL: http://product:8002
  #     PRODUCT_CLIENT_TYPE: ${PRODUCT_CLIENT_TYPE:-grpc}
  #     PRODUCT_GRPC_HOST: product
  #     PRODUCT_GRPC_PORT: 50051
  #     OTEL_ENABLED: true
  #     OTEL_SERVICE_NAME: order-service
  #     OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
  #     OTEL_SEMCONV_STABILITY_OPT_IN: http
  #     UVICORN_WORKERS: ${UVICORN_WORKERS:-1}
  #   command: >
  #     sh -c "uvicorn src.main:app --host 0.0.0.0 --port 8003 --workers $${UVICORN_WORKERS:-1}"
  #   healthcheck:
  #     test:
  #       [
  #         "CMD",
  #         "python",
  #         "-c",
  #         "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')",
  #       ]
  #     interval: 5s
  #     timeout: 5s
  #     retries: 5
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     product:
  #       condition: service_healthy
  #   networks:
  #     - flash-network
  #     - monitoring-network

  # Go Order Service
  order:
    build:
      context: .
      dockerfile: services/order/go/Dockerfile
    container_name: flash-deals-order
    environment:
      APP_PORT: 8003
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: flash_deals
      DB_USER: flash
      DB_PASSWORD: flash1234
      # Redis (for async order processing)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Async Order Processing
      ASYNC_ORDER_ENABLED: ${ASYNC_ORDER_ENABLED:-false}
      # Product Service gRPC
      PRODUCT_GRPC_HOST: product
      PRODUCT_GRPC_PORT: 50051
      # OpenTelemetry
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_SERVICE_NAME: order-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8003/health"]
      interval: 5s
      timeout: 5s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      product:
        condition: service_healthy
    networks:
      - flash-network
      - monitoring-network

volumes:
  postgres_data:
  redis_data:

networks:
  flash-network:
    driver: bridge
  monitoring-network:
    name: flash-deals_monitoring-network
    external: true
