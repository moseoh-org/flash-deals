openapi: 3.0.4
info:
  title: Order Service API
  description: 주문 생성 및 관리 서비스
  version: 1.0.0
  contact:
    name: Flash Deal Team

servers:
  - url: http://localhost:8003
    description: Local development server

tags:
  - name: orders
    description: 주문 관리 API

paths:
  /health:
    get:
      summary: 헬스 체크
      operationId: healthCheck
      responses:
        "200":
          description: 서비스 정상
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /orders/health:
    get:
      summary: 헬스 체크 (Gateway 경유)
      operationId: healthCheckViaGateway
      responses:
        "200":
          description: 서비스 정상
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /orders:
    get:
      tags:
        - orders
      summary: 내 주문 목록 조회
      operationId: listMyOrders
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, shipped, delivered, cancelled]
      responses:
        "200":
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "401":
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      tags:
        - orders
      summary: 주문 생성
      description: 일반 상품 또는 핫딜 상품 주문 생성
      operationId: createOrder
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderRequest"
      responses:
        "201":
          description: 주문 생성 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "400":
          description: 잘못된 요청 (재고 부족 등)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: 동시성 충돌 (다시 시도 필요)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /orders/{order_id}:
    get:
      tags:
        - orders
      summary: 주문 상세 조회
      operationId: getOrder
      security:
        - bearerAuth: []
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "401":
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: 접근 권한 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 주문 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /orders/{order_id}/cancel:
    post:
      tags:
        - orders
      summary: 주문 취소
      operationId: cancelOrder
      security:
        - bearerAuth: []
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CancelOrderRequest"
      responses:
        "200":
          description: 주문 취소 성공
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderResponse"
        "400":
          description: 취소 불가 상태
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: 접근 권한 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: 주문 없음
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - service
      properties:
        status:
          type: string
          example: healthy
        service:
          type: string
          example: order-service

    CreateOrderRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          minItems: 1
          maxItems: 10
          items:
            $ref: "#/components/schemas/OrderItemRequest"
        shipping_address:
          $ref: "#/components/schemas/ShippingAddress"

    OrderItemRequest:
      type: object
      required:
        - product_id
        - quantity
      properties:
        product_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        deal_id:
          type: string
          format: uuid
          description: 핫딜 주문 시 핫딜 ID
          example: 660e8400-e29b-41d4-a716-446655440001
        quantity:
          type: integer
          minimum: 1
          maximum: 10
          example: 1

    ShippingAddress:
      type: object
      required:
        - recipient_name
        - phone
        - address
        - postal_code
      properties:
        recipient_name:
          type: string
          maxLength: 50
          example: 홍길동
        phone:
          type: string
          pattern: "^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$"
          example: 010-1234-5678
        address:
          type: string
          maxLength: 200
          example: 서울시 강남구 테헤란로 123
        address_detail:
          type: string
          maxLength: 100
          example: 456호
        postal_code:
          type: string
          pattern: "^[0-9]{5}$"
          example: "06234"

    CancelOrderRequest:
      type: object
      properties:
        reason:
          type: string
          maxLength: 500
          example: 단순 변심

    OrderResponse:
      type: object
      required:
        - id
        - user_id
        - items
        - total_amount
        - status
        - created_at
      properties:
        id:
          type: string
          format: uuid
          example: 770e8400-e29b-41d4-a716-446655440002
        user_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItemResponse"
        total_amount:
          type: integer
          description: 총 결제 금액 (원)
          example: 1990000
        status:
          type: string
          enum: [pending, confirmed, shipped, delivered, cancelled]
          example: confirmed
        shipping_address:
          $ref: "#/components/schemas/ShippingAddress"
        cancelled_at:
          type: string
          format: date-time
        cancel_reason:
          type: string
        created_at:
          type: string
          format: date-time
          example: 2024-01-20T12:00:05Z
        updated_at:
          type: string
          format: date-time
          example: 2024-01-20T12:00:05Z

    OrderItemResponse:
      type: object
      required:
        - id
        - product_id
        - product_name
        - quantity
        - unit_price
        - subtotal
      properties:
        id:
          type: string
          format: uuid
          example: 880e8400-e29b-41d4-a716-446655440003
        product_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        deal_id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        product_name:
          type: string
          example: 애플 맥북 프로 14인치
        quantity:
          type: integer
          example: 1
        unit_price:
          type: integer
          description: 주문 당시 단가
          example: 1990000
        subtotal:
          type: integer
          description: 소계 (단가 x 수량)
          example: 1990000

    OrderListResponse:
      type: object
      required:
        - items
        - total
        - page
        - size
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderResponse"
        total:
          type: integer
          example: 5
        page:
          type: integer
          example: 1
        size:
          type: integer
          example: 20

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: OUT_OF_STOCK
        message:
          type: string
          example: 재고가 부족합니다.
        details:
          type: object
          additionalProperties: true
